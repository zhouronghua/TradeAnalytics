# 成交量规则变更说明

## 变更内容

**修改日期**: 2026-02-06

### 原规则
成交量倍数 = 当天成交量 / 前一天成交量

### 新规则
成交量倍数 = 当天成交量 / 前7天平均成交量

## 修改原因

原规则使用前一天的成交量作为基准，可能会受到单日异常波动的影响。改用前7天平均成交量作为基准，更能反映股票的正常成交水平，使得异常成交量的识别更加准确和稳定。

## 优势对比

### 原规则的问题
- 如果前一天恰好成交量很低，容易误判
- 如果前一天成交量异常高，会漏掉真正的暴涨
- 对单日波动敏感，容易出现噪音

### 新规则的优势
- 使用7天平均，更能代表正常水平
- 抗单日异常波动干扰
- 识别真正的成交量暴涨更准确
- 符合技术分析的常规做法

## 实现细节

### 代码修改

**文件**: `src/volume_analyzer.py`

**修改前**:
```python
for i in range(1, len(recent_data)):
    current = recent_data.iloc[i]
    previous = recent_data.iloc[i-1]
    
    volume_ratio = current['volume'] / previous['volume'] if previous['volume'] > 0 else 0
    
    if volume_ratio >= 5.0 and current['close'] > current['ma']:
        results.append({
            ...
            'prev_volume': previous['volume'],
            'volume_ratio': volume_ratio,
            ...
        })
```

**修改后**:
```python
for i in range(7, len(recent_data)):  # 需要至少8天数据：当天 + 前7天
    current = recent_data.iloc[i]
    
    # 计算前7天的平均成交量
    prev_7_days = recent_data.iloc[i-7:i]
    avg_7day_volume = prev_7_days['volume'].mean()
    
    # 检查条件：当天成交量是前7天平均成交量的5倍以上
    volume_ratio = current['volume'] / avg_7day_volume if avg_7day_volume > 0 else 0
    
    if volume_ratio >= 5.0 and current['close'] > current['ma']:
        results.append({
            ...
            'avg_7day_volume': int(avg_7day_volume),
            'volume_ratio': volume_ratio,
            ...
        })
```

### GUI 显示更新

**文件**: `src/gui.py`

**列头修改**:
- 原：'前日成交量'
- 新：'前7日平均量'

**数据字段修改**:
- 原：`row['prev_volume']`
- 新：`row['avg_7day_volume']`

## 数据要求

使用新规则需要至少 **8个交易日** 的数据（当天 + 前7天）。

对于数据不足8天的股票：
- 会自动跳过该股票的分析
- 不会报错或影响其他股票的分析

## 使用建议

1. **首次使用**: 确保已下载足够的历史数据（建议至少120天）
2. **重新分析**: 使用"成交量暴涨分析"功能重新扫描现有数据
3. **结果对比**: 新规则可能筛选出的股票数量会减少，但质量更高

## 测试验证

### 测试场景

假设某股票近10天的成交量数据如下：

| 日期 | 成交量 | 前1日 | 前7日平均 | 倍数(前1日) | 倍数(前7日平均) |
|------|--------|-------|----------|------------|---------------|
| Day 1 | 100万 | - | - | - | - |
| Day 2 | 110万 | 100万 | - | 1.1x | - |
| Day 3 | 90万 | 110万 | - | 0.82x | - |
| Day 4 | 120万 | 90万 | - | 1.33x | - |
| Day 5 | 80万 | 120万 | - | 0.67x | - |
| Day 6 | 100万 | 80万 | - | 1.25x | - |
| Day 7 | 110万 | 100万 | - | 1.1x | - |
| Day 8 | 600万 | 110万 | 101.4万 | 5.45x | **5.91x** |

在 Day 8，成交量暴涨到600万：
- **原规则**: 600万 / 110万 = 5.45倍（符合）
- **新规则**: 600万 / 101.4万 = 5.91倍（符合）

如果 Day 7 恰好也是异常高（比如500万）：
- **原规则**: 600万 / 500万 = 1.2倍（不符合，漏判）
- **新规则**: 600万 / 130万（7天平均）= 4.6倍（接近但可能不符合）

可见新规则更稳定，不会因为单日异常而漏判或误判。

## 相关文件

- **核心逻辑**: `src/volume_analyzer.py`
- **GUI显示**: `src/gui.py`
- **配置文件**: `config/config.ini`（成交量倍数阈值仍为5.0）

## 总结

新规则提供了更稳定、更准确的成交量异常检测：
- 基准更合理（7天平均 vs 单日）
- 抗干扰能力强
- 符合技术分析常规
- 可能筛选出的股票数量减少，但质量提升

建议所有用户更新代码后重新进行成交量分析。
