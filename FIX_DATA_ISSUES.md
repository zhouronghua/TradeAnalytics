# 数据问题完整解决方案

## 当前问题

1. **后台进程未停止**：退出GUI后，下载进程仍在运行
2. **数据不准确**：部分旧的AkShare数据仍在使用
3. **混合数据源**：系统中同时存在AkShare和BaoStock的数据

## 问题根源

### 1. 进程管理问题
- GUI关闭后，后台的下载线程仍在运行
- 需要强制停止所有Python进程

### 2. 数据混乱
```
旧数据（AkShare）：价格不准确，如600343显示55元
新数据（BaoStock）：价格准确，如600343显示34.32元
```

### 3. 数据验证结果
```
本地600343.csv: 55.12元（错误）
BaoStock实时:   34.32元（正确）
差异: 60.61%
```

## 完整解决方案

### 步骤1：停止所有进程并清理数据

运行清理脚本：
```bash
COMPLETE_CLEANUP.bat
```

**或者手动执行以下命令：**

```powershell
# 1. 停止所有Python进程
taskkill /F /IM python.exe /T

# 2. 删除所有旧数据
Remove-Item data\daily\*.csv -Force
Remove-Item data\stocks\stock_list.csv -Force
Remove-Item data\results\*.csv -Force

# 3. 验证配置
Get-Content config\config.ini | Select-String "source"
```

### 步骤2：验证配置文件

确保 `config/config.ini` 正确配置：

```ini
[DataSource]
source = baostock  # 必须是baostock
```

### 步骤3：重新下载数据

```bash
python main.py
```

### 预期结果

程序启动后会：
1. ✅ 使用BaoStock登录
2. ✅ 下载7095只股票列表
3. ✅ 逐个下载股票历史数据（150天）
4. ✅ 所有价格数据准确

## BaoStock数据特点

### 优点
- ✅ 官方API，稳定可靠
- ✅ 数据准确，与市场价格一致
- ✅ 无访问限制
- ✅ 完全免费

### 注意事项
- ⚠️ 数据延迟T+1（延迟1天）
- ⚠️ 部分停牌或退市股票可能无数据（正常）
- ⚠️ 首次下载需要20-30分钟

### 数据为空的情况
如果看到日志显示"股票 XXX 数据为空"，可能是：
1. 股票已退市
2. 股票代码不存在
3. 股票列表中包含指数代码
4. 临时网络问题

**这是正常的，不影响有效股票的下载。**

## 验证数据准确性

运行验证脚本：
```bash
python verify_600343.py
```

期望输出：
```
本地文件价格: 34.32 元
BaoStock价格: 34.32 元
[OK] 价格一致，数据正确！
```

## 防止问题再次发生

### 1. 正确退出程序
- 点击GUI的"停止任务"按钮
- 等待"已停止"提示
- 再关闭窗口

### 2. 不要混用数据源
- 切换数据源后，必须清理旧数据
- 不要手动修改CSV文件

### 3. 定期验证
- 使用 `verify_600343.py` 验证数据
- 检查日志文件确认数据源

## 常见问题

### Q1: 为什么退出GUI后还在下载？
A: 下载使用多线程，GUI关闭不会自动停止线程。需要先点击"停止任务"。

### Q2: 如何确认使用的是BaoStock？
A: 查看日志，应该显示：
```
[INFO] [DataDownloader] 使用BaoStock数据源
[INFO] [BaoStock] BaoStock登录成功
```

### Q3: 下载很慢怎么办？
A: BaoStock是串行下载（逐个股票），比AkShare慢但更稳定。
   可以降低 `max_workers` 减少并发。

### Q4: 数据"为空"是错误吗？
A: 不是。很多股票代码可能已退市或不存在，跳过这些是正常的。

## 当前系统状态

执行完清理后：
- ✅ 所有旧数据已删除
- ✅ 配置文件正确（BaoStock）
- ✅ 准备重新下载
- ⏳ 等待运行 `python main.py`

## 预期下载时间

- 股票列表：10秒
- 单只股票：2-5秒
- 全部7095只：约4-8小时（因为很多股票会跳过）
- 有效股票约5000只：约2-4小时

建议：
1. 晚上或周末运行
2. 不要中途关闭
3. 可以查看logs了解进度

## 下一步

1. 运行 `COMPLETE_CLEANUP.bat`
2. 确认清理完成
3. 运行 `python main.py`
4. 等待下载完成
5. 验证数据准确性
