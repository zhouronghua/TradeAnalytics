# 单线程配置说明

## 问题描述

**日期**: 2026-02-06

在使用多线程（max_workers = 3）下载数据时，BaoStock服务器会拒绝连接，导致下载失败。

## 解决方案

将配置改回单线程模式，避免触发服务器的连接限制。

### 配置修改

**文件**: `config/config.ini`

**修改**:
```ini
[Download]
# 并发线程数：服务器限制，使用单线程避免拒绝连接
max_workers = 1
```

## 原因分析

### BaoStock服务器限制

BaoStock是免费的金融数据接口，服务器对单个用户的并发连接有限制：

1. **连接频率限制**: 短时间内过多连接会被识别为异常行为
2. **IP限制**: 可能对单个IP的并发请求数有限制
3. **资源保护**: 防止单个用户占用过多服务器资源

### 多线程的问题

虽然我们实现了线程安全的BaoStock包装器（`ThreadSafeBaoStockDataSource`），但是：
- 每个线程会创建独立的BaoStock连接
- 3个线程 = 3个并发连接
- 可能触发服务器的连接数限制
- 导致连接被拒绝

## 性能影响

### 单线程 vs 多线程

| 配置 | 优点 | 缺点 |
|------|------|------|
| 单线程 (max_workers=1) | 稳定可靠，不会被拒绝 | 下载速度较慢 |
| 多线程 (max_workers=3) | 下载速度快3倍 | 可能被服务器拒绝 |

### 预估下载时间

假设下载4308只股票，每只需要0.5秒：

- **单线程**: 4308 × 0.5秒 ≈ 36分钟
- **三线程**: 4308 × 0.5秒 / 3 ≈ 12分钟（理想情况）

虽然单线程较慢，但保证了稳定性和成功率。

## 替代方案

如果需要提高下载速度，可以考虑以下方案：

### 1. 分时段下载

不要一次性下载所有股票，可以分多个时段：
- 上午下载一部分
- 下午下载一部分
- 第二天继续

### 2. 增量更新

程序已支持增量更新，只下载新增的交易日数据，大大减少下载量。

### 3. 延长重试间隔

如果确实需要多线程，可以：
```ini
[Download]
max_workers = 2  # 降到2个线程
retry_times = 3
retry_delay = 10  # 增加重试延迟到10秒
```

### 4. 本地缓存

程序会缓存已下载的数据，避免重复下载：
- 股票列表缓存1天
- 历史数据永久缓存
- 只下载最新的增量数据

## 错误日志示例

多线程被拒绝时可能看到的错误：
```
[WARNING] [DataDownloader] 下载股票 000041 数据失败 (尝试 1/3): Connection refused
[WARNING] [DataDownloader] 下载股票 000038 数据失败 (尝试 3/3): timeout
[ERROR] [DataDownloader] 股票 000038 下载失败，已达最大重试次数
```

## 验证配置

启动程序后，检查日志：
```
[INFO] [DataDownloader] 使用BaoStock数据源（线程安全版本）
[INFO] [DataDownloader] 数据下载器初始化完成（每日下载限制: 0MB）
```

下载时应该看到：
- 下载速度较慢但稳定
- 很少或没有连接错误
- 成功率接近100%

## 建议

对于日常使用：

1. **首次下载**: 使用单线程，耐心等待（约30-40分钟）
2. **日常更新**: 增量更新非常快（通常1-2分钟）
3. **定时任务**: 设置每天15:30自动更新，无需手动操作

## 总结

虽然单线程速度较慢，但考虑到：
- BaoStock是免费服务
- 需要稳定可靠的数据
- 增量更新很快
- 可以设置自动定时任务

使用单线程是最佳选择，保证了数据完整性和下载成功率。

## 更新记录

- 2026-02-06: 从多线程(3)改回单线程(1)，避免服务器拒绝连接
