# 微信公众号推送配置指南

## 概述

使用微信公众号推送相比Server酱的优势：
- ✅ 推送给关注公众号的特定用户
- ✅ 可以推送给多个用户
- ✅ 推送次数无限制
- ✅ 更正式、专业的展示
- ✅ 可以自定义模板

## 前置要求

### 1. 公众号类型选择

**推荐：服务号（认证）**
- 费用：300元/年认证费
- 可以发送模板消息
- 每月4条群发消息
- 适合：个人或小团队正式使用

**备选：订阅号（未认证）**
- 免费
- 只能发送客服消息（功能有限）
- 每天1条群发消息
- 适合：仅自己使用

### 2. 所需权限

- 模板消息权限（服务号认证后自动获得）
- 开发者权限
- 服务器配置权限

## 方案对比

### 方案1：模板消息（推荐）

**优点**：
- 推送及时
- 格式规范
- 用户体验好
- 点击可跳转

**缺点**：
- 需要认证服务号（300元/年）
- 需要用户关注公众号

**适合**：正式商业应用、团队使用

### 方案2：客服消息

**优点**：
- 订阅号即可使用
- 免费

**缺点**：
- 48小时内有互动才能发送
- 功能受限

**适合**：仅自己使用，经常和公众号互动

## 申请流程

### 第一步：注册公众号

1. 访问：https://mp.weixin.qq.com/
2. 点击"立即注册"
3. 选择"服务号"
4. 填写基本信息
5. 完成注册

### 第二步：认证公众号（服务号）

1. 登录公众号后台
2. 点击"设置" → "微信认证"
3. 按提示提交资料
4. 支付300元认证费
5. 等待审核（通常3-5个工作日）

**个人用户注意**：
- 个人无法注册服务号
- 可以注册订阅号，但功能有限
- 建议使用企业/个体工商户身份注册

### 第三步：获取开发者凭证

1. 登录公众号后台
2. 点击"设置与开发" → "基本配置"
3. 记录以下信息：
   - **AppID**（应用ID）
   - **AppSecret**（应用密钥，点击"重置"生成）

**重要**：AppSecret只显示一次，务必保存好！

### 第四步：配置服务器

如果需要接收用户消息（可选）：

1. "设置与开发" → "基本配置" → "服务器配置"
2. 填写：
   - URL：你的服务器地址
   - Token：自定义令牌
   - EncodingAESKey：随机生成
3. 提交验证

**注意**：仅推送消息不需要配置服务器。

### 第五步：创建模板消息

1. 登录公众号后台
2. 点击"功能" → "模板消息"
3. 点击"模板库"
4. 搜索或选择合适的模板，如"数据统计通知"
5. 记录模板ID

**推荐模板**：
- 数据统计通知
- 服务提醒
- 行情提醒

或者创建自定义模板（需要审核）。

### 第六步：获取用户OpenID

用户关注公众号后，需要获取他们的OpenID才能推送消息。

**方法1：通过接口获取**
1. 用户关注公众号
2. 后台"用户管理"查看OpenID
3. 或通过API获取：
   ```
   GET https://api.weixin.qq.com/cgi-bin/user/get?access_token=ACCESS_TOKEN
   ```

**方法2：让用户发送消息**
1. 用户发送任意消息到公众号
2. 你的服务器接收到消息中包含OpenID
3. 记录OpenID

**简单方法**：
1. 关注你的公众号
2. 发送"绑定"
3. 公众号回复你的OpenID
4. 将OpenID配置到程序中

## 配置程序

### 编辑 config/config.ini

```ini
[Notification]
# 启用推送
enabled = true

# 使用微信公众号
push_type = wechat_official

# Server酱配置（保留，可作为备用）
serverchan_key = 

# 微信公众号配置
wechat_appid = wx你的AppID
wechat_secret = 你的AppSecret
wechat_template_id = 你的模板ID
# 接收推送的用户OpenID列表（逗号分隔）
wechat_openids = oXXXXXXXXXXXXXXXXXXXXXXXXXX,oYYYYYYYYYYYYYYYYYYYYYYYYYY

# 推送配置
push_history_days = 3
push_max_stocks = 20
```

### 获取多个用户的OpenID

如果要推送给多个用户：

```python
# 运行这个脚本获取所有关注者
python get_followers.py
```

这会列出所有关注者的OpenID，然后将需要接收推送的OpenID添加到配置中。

## 测试推送

```bash
python test_push.py
```

如果配置正确，关注公众号的用户会收到测试消息。

## 推送效果

### 消息展示

```
【股票分析结果】

今日符合条件：8只
成交量增长≥5倍且价格>均线

近3日趋势：
今天：8只 📍
昨天：12只 📉
前天：6只 📈

详情：
603616 乐凯胶片
成交量倍数：24.12
价格涨幅：44.93%
...更多...

点击查看详情 >
```

### 点击跳转（可选）

可以配置点击后跳转到：
- H5页面显示详细数据
- 公众号文章
- 小程序
- 网页链接

## 费用说明

### 一次性费用
- 认证费：300元/年（服务号必需）

### 使用费用
- 模板消息：完全免费
- 推送次数：无限制
- 带宽流量：免费

### 总计
- 第一年：300元
- 后续每年：300元（续费认证）

## 与其他方案对比

| 方案 | 费用 | 推送次数 | 用户体验 | 配置难度 |
|------|------|----------|----------|----------|
| Server酱 | 免费 | 5次/天 | 普通 | 简单 |
| 企业微信 | 免费 | 无限 | 较好 | 简单 |
| 微信公众号 | 300元/年 | 无限 | 最好 | 中等 |

## 高级功能

### 1. 推送给多个用户

```ini
# 配置多个OpenID
wechat_openids = oUser1,oUser2,oUser3
```

程序会自动推送给所有配置的用户。

### 2. 分组推送

可以为不同用户设置不同的推送内容：

```ini
# 管理员（推送详细信息）
wechat_admin_openids = oAdmin1
# 普通用户（推送摘要）
wechat_user_openids = oUser1,oUser2
```

### 3. 自定义模板

在公众号后台创建自定义模板，可以完全按你的需求设计消息格式。

### 4. 点击跳转详情

可以在推送消息中添加链接，点击查看详细的股票数据页面。

## 常见问题

### Q1: 个人可以申请服务号吗？

**不可以**。服务号需要企业/组织/个体工商户资质。

**解决方案**：
- 注册订阅号（功能有限）
- 使用Server酱（推荐）
- 使用企业微信（推荐）
- 注册个体工商户（成本较高）

### Q2: 认证失败怎么办？

**常见原因**：
- 资料不全
- 企业信息不匹配
- 运营者信息错误

**解决方案**：
- 按照审核意见补充材料
- 联系微信客服
- 重新提交认证

### Q3: 如何获取用户的OpenID？

**最简单方法**：
1. 你自己关注公众号
2. 公众号后台"用户管理"查看
3. 或让用户发送"绑定"，自动回复OpenID

### Q4: 模板消息发送失败？

**检查清单**：
- [ ] AppID和AppSecret正确
- [ ] 模板ID正确
- [ ] OpenID正确
- [ ] 用户已关注公众号
- [ ] 模板消息权限已开通

### Q5: 可以推送图片吗？

**模板消息不支持图片**，但可以：
- 在公众号发布图文消息
- 模板消息中添加链接跳转到图文
- 使用客服消息发送图片

### Q6: 推送频率有限制吗？

**模板消息无频率限制**，但建议：
- 每天不超过5条
- 非紧急情况合并推送
- 避免骚扰用户

### Q7: 用户取消关注后会怎样？

- 程序会收到错误：用户未关注
- 不会影响其他用户的推送
- 建议在日志中记录，定期清理

## 安全建议

### 1. 保护AppSecret
- 不要上传到GitHub
- 不要硬编码到代码中
- 使用环境变量或配置文件

### 2. 定期更换密钥
- 每3个月更换一次AppSecret
- 更换后更新配置文件

### 3. 监控异常
- 记录所有推送日志
- 监控失败率
- 异常时及时处理

### 4. 用户隐私
- 不要泄露用户的OpenID
- 遵守微信平台规范
- 征得用户同意后推送

## 开发资源

### 官方文档
- 公众平台文档：https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html
- 模板消息API：https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html

### 在线工具
- 微信公众平台接口测试工具：https://mp.weixin.qq.com/debug/

### Python库
- wechatpy：功能完整的微信SDK
- weixin-python：轻量级封装

## 故障排除

### 检查AccessToken

```bash
python -c "from src.notification import WeChatOfficialPusher; p = WeChatOfficialPusher(); print(p.get_access_token())"
```

### 检查模板

```bash
python check_template.py
```

### 查看日志

```bash
type logs\notification.log
```

## 总结

**适合使用公众号推送的场景**：
- ✅ 正式的商业应用
- ✅ 团队协作使用
- ✅ 需要推送给多人
- ✅ 有300元/年预算
- ✅ 有企业/组织资质

**不适合的场景**：
- ❌ 个人用户（无企业资质）
- ❌ 临时使用
- ❌ 预算有限
- ❌ 只推送给自己

**个人用户推荐**：
- Server酱（最简单）
- 企业微信（免费且功能强）

如果确实需要使用公众号，建议：
1. 先用Server酱测试功能
2. 确认需求后再申请公众号
3. 或者使用朋友的企业公众号
